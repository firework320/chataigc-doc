# 更新升级指南

## 更新操作说明

### ⚠️ 重要提示
更新前请务必做好以下备份工作：
- 数据库完整备份
- 源码目录完整备份
- 重要配置文件备份

建议使用以下备份方式：
1. 数据库导出SQL文件
2. 源码目录打包压缩
3. 关键配置文件单独备份

## 升级方式

### 方式一：在线升级

#### 适用条件
- 使用完整项目源码
- 未进行目录结构调整
- 未进行二次开发

#### 升级步骤

1. **关闭防跨站攻击**
   - 进入宝塔面板
   - 选择【网站列表】->【设置】->【网站目录】
   - 临时关闭【防跨站攻击(open_basedir)】
   ![关闭防跨站](https://doc.chatmoney.cn/docs/images/general/php/update/update-1-1.png)

2. **重启Nginx服务**
   - 进入【软件商店】
   - 找到Nginx，选择【设置】->【重启】
   ![重启Nginx](https://doc.chatmoney.cn/docs/images/general/php/update/update-1-2.png)

3. **重启PHP服务**
   - 进入【软件商店】
   - 找到PHP-8.0，选择【服务】->【重启】
   ![重启PHP](https://doc.chatmoney.cn/docs/images/general/php/update/update-1-3.png)

4. **执行系统更新**
   - 登录后台
   - 进入【系统设置】->【系统维护】->【系统更新】
   - 点击【一键更新】

5. **恢复安全设置**
   - 重新开启【防跨站攻击(open_basedir)】

6. **清理系统缓存**
   - 进入【系统设置】->【系统维护】->【系统缓存】
   - 点击【清理缓存】

7. **小程序更新**
   - 重新发布小程序版本

### 方式二：手动升级

#### 升级步骤

1. **备份关键文件**
   - server/.env
   - server/config/install.lock
   - server/public/uploads
   - server/license/my.license

2. **替换源码**
   - 下载最新源码包
   - 删除现有server目录
   - 替换为最新server目录
   - 恢复备份的关键文件

3. **数据库处理**
   - 修改like.sql表前缀（如需要）
   - 新建测试数据库并导入like.sql
   - 使用Navicat同步数据结构

## 常见问题处理

### 1. 授权相关问题

#### 1.1 IP未授权
- 登录官网授权中心
- 添加服务器外网IP
- 添加项目域名

#### 1.2 域名授权异常
- 检查站点域名配置
- 确保仅保留一个授权域名
- 删除未授权域名

### 2. 升级失败处理

#### 2.1 跨域攻击提示
- 确认已关闭防跨站攻击
- 检查目录权限设置

#### 2.2 500错误排查

**可能原因：**
- 目录结构被修改
- 文件权限不足
- PHP缺少ZipArchive扩展

**解决方案：**
- 恢复标准目录结构
- 设置目录权限为www用户
- 安装PHP Zip扩展